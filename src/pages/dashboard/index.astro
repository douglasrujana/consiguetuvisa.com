---
// src/pages/dashboard/index.astro
import Layout from '../../components/global/Layout.astro';
import { SignedIn, SignedOut } from '@clerk/astro/components';
import { createClerkClient } from '@clerk/astro/server';
import UserDashboard from '../../components/dashboard/UserDashboard.svelte';
import Button from '../../components/ui/Button.astro';
import { getBasicServices } from '@core/di/ContextFactory';
import { validateCreateUserFromClerk } from '@features/user';

// Obtener usuario de Clerk
const { auth } = Astro.locals as any;
const { userId } = auth();

let localUser = null;
let userName = 'Usuario';
let isAdmin = false;

// Si hay usuario autenticado, sincronizar con Turso
if (userId) {
  try {
    const { userService } = getBasicServices();
    
    // Primero buscar si ya existe
    localUser = await userService.getByExternalId(userId);
    
    // Si no existe, obtener de Clerk y crear
    if (!localUser) {
      const clerk = createClerkClient({
        secretKey: import.meta.env.CLERK_SECRET_KEY,
        publishableKey: import.meta.env.PUBLIC_CLERK_PUBLISHABLE_KEY,
      });
      
      const clerkUser = await clerk.users.getUser(userId);
      const email = clerkUser.emailAddresses[0]?.emailAddress;
      
      if (email) {
        const validatedData = validateCreateUserFromClerk({
          externalId: userId,
          email,
          firstName: clerkUser.firstName,
          lastName: clerkUser.lastName,
        });
        
        localUser = await userService.syncFromClerk(validatedData);
        console.log('[Dashboard] User synced:', email);
      }
    }
    
    if (localUser) {
      userName = localUser.firstName || localUser.email?.split('@')[0] || 'Usuario';
      isAdmin = localUser.role === 'ADMIN';
      // Admin tiene acceso dual: puede ver su dashboard personal Y el admin
    }
  } catch (error) {
    console.error('[Dashboard] Error syncing user:', error);
  }
}

// Verificar si hay error de acceso admin
const url = new URL(Astro.request.url);
const adminError = url.searchParams.get('error') === 'admin_required';
---

<Layout title="Mi Panel">
  <section class="py-12 bg-slate-50 min-h-screen">
    <div class="max-w-6xl mx-auto px-6">
      <SignedOut>
        <div class="bg-white rounded-3xl p-16 text-center">
          <h1 class="text-2xl font-semibold text-slate-800 mb-3">Acceso Restringido</h1>
          <p class="text-slate-400 mb-8">Debes iniciar sesión para ver tu panel.</p>
          <Button href="/login">Iniciar Sesión</Button>
        </div>
      </SignedOut>

      <SignedIn>
        {adminError && (
          <div class="mb-6 p-5 bg-amber-50 rounded-2xl">
            <p class="text-amber-700 text-sm">
              <strong>Acceso denegado:</strong> No tienes permisos de administrador.
            </p>
          </div>
        )}

        {isAdmin && (
          <div class="mb-8 p-6 bg-white rounded-3xl flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex items-center gap-4">
              <span class="w-12 h-12 bg-slate-900 rounded-2xl flex items-center justify-center text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>
              </span>
              <div>
                <p class="font-medium text-slate-800">Modo Administrador</p>
                <p class="text-sm text-slate-400">Acceso al panel de administración</p>
              </div>
            </div>
            <a 
              href="/admin" 
              class="inline-flex items-center gap-2 bg-slate-900 text-white px-5 py-2.5 rounded-full text-sm font-medium hover:bg-slate-800 transition-colors"
            >
              Panel Admin
            </a>
          </div>
        )}

        <UserDashboard 
          client:load 
          userId={userId || ''} 
          userName={userName}
        />
      </SignedIn>
    </div>
  </section>
</Layout>
