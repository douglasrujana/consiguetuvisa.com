generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ============================================
// USUARIOS EXTERNOS (Clientes/Leads)
// ============================================

model Customer {
  id            String   @id @default(uuid())
  clerkId       String?  @unique // Clerk ID para auth
  email         String   @unique
  firstName     String?
  lastName      String?
  phone         String?
  source        String?  // 'web' | 'referral' | 'social' | 'ads' | 'whatsapp'
  status        String   @default("LEAD") // LEAD | ACTIVE | INACTIVE
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  solicitudes   Solicitud[]
  appointments  Appointment[]
  documents     Document[]
  notes         Note[]         @relation("CustomerNotes")
  conversations Conversation[]
}

// ============================================
// USUARIOS INTERNOS (Equipo/Staff)
// ============================================

model StaffMember {
  id            String   @id @default(uuid())
  clerkId       String?  @unique // Clerk ID para auth (opcional para seed)
  email         String   @unique
  firstName     String
  lastName      String
  role          String   // ADMIN | SALES | COMMUNITY | DEV | SUPPORT
  department    String?
  permissions   String?  // JSON array de permisos específicos
  isActive      Boolean  @default(true)
  invitedBy     String?  // ID del StaffMember que lo invitó
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  assignedSolicitudes Solicitud[]     @relation("AssignedAgent")
  createdNotes        Note[]          @relation("NoteCreator")
  createdAlerts       Alert[]         @relation("AlertCreator")
  acknowledgedAlerts  Alert[]         @relation("AlertAcknowledger")
  reviewedDocuments   Document[]      @relation("DocumentReviewer")
  statusChanges       StatusHistory[] @relation("StatusChanger")
}

// ============================================
// USUARIOS LEGACY (Deprecado - migrar a Customer/StaffMember)
// ============================================

model User {
  id            String   @id @default(uuid())
  externalId    String?  @unique // Clerk ID, Supabase ID, etc.
  email         String   @unique
  firstName     String?
  lastName      String?
  phone         String?
  role          String   @default("USER") // USER, ADMIN, AGENT
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  migratedTo    String?  // 'customer' | 'staff' - indica si ya fue migrado
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// SOLICITUDES DE VISA (Core del negocio)
// ============================================

model Solicitud {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Tipo de visa
  visaType           String // USA_TURISMO, CANADA_VISITANTE, SCHENGEN, UK, MEXICO, OTRO
  destinationCountry String

  // Estado del proceso
  status      String @default("NUEVA") // NUEVA, EN_REVISION, DOCUMENTOS, FORMULARIO, CITA_AGENDADA, ENTREVISTA, APROBADA, RECHAZADA, CANCELADA
  currentStep Int    @default(1)
  totalSteps  Int    @default(5)

  // Datos del solicitante
  fullName       String
  birthDate      DateTime?
  nationality    String?
  passportNumber String?
  passportExpiry DateTime?

  // Datos de contacto
  phone String
  email String
  city  String?

  // Datos del viaje
  travelPurpose String?
  travelDate    DateTime?
  returnDate    DateTime?

  // Información adicional
  hasVisaHistory   Boolean @default(false)
  visaHistoryNotes String?
  hasDenials       Boolean @default(false)
  denialNotes      String?

  // Integración externa
  bitrixLeadId String? // ID del lead en Bitrix24
  bitrixDealId String? // ID del deal en Bitrix24

  // Fechas importantes
  appointmentDate DateTime?
  interviewDate   DateTime?

  // Metadata
  source          String? // WEB, WHATSAPP, REFERIDO, LANDING_NAVIDAD
  assignedAgentId String?
  assignedAgent   StaffMember? @relation("AssignedAgent", fields: [assignedAgentId], references: [id])
  priority        String  @default("NORMAL") // LOW, NORMAL, HIGH, URGENT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  documents     Document[]
  notes         Note[]
  statusHistory StatusHistory[]
}

// ============================================
// HISTORIAL DE ESTADOS
// ============================================

model StatusHistory {
  id          String    @id @default(uuid())
  solicitudId String
  solicitud   Solicitud @relation(fields: [solicitudId], references: [id])

  fromStatus  String?
  toStatus    String
  changedById String?
  changedBy   StaffMember? @relation("StatusChanger", fields: [changedById], references: [id])
  reason      String?

  createdAt DateTime @default(now())
}

// ============================================
// DOCUMENTOS
// ============================================

model Document {
  id          String     @id @default(uuid())
  solicitudId String?
  solicitud   Solicitud? @relation(fields: [solicitudId], references: [id])
  customerId  String
  customer    Customer   @relation(fields: [customerId], references: [id])

  name     String
  type     String // PASAPORTE, FOTO, COMPROBANTE_INGRESOS, CARTA_TRABAJO, DS160, OTRO
  fileUrl  String?
  fileName String?
  fileSize Int?
  mimeType String?

  status       String       @default("PENDIENTE") // PENDIENTE, RECIBIDO, APROBADO, RECHAZADO
  reviewNotes  String?
  reviewedById String?
  reviewedBy   StaffMember? @relation("DocumentReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// NOTAS Y COMENTARIOS
// ============================================

model Note {
  id          String     @id @default(uuid())
  solicitudId String?
  solicitud   Solicitud? @relation(fields: [solicitudId], references: [id])
  customerId  String?
  customer    Customer?  @relation("CustomerNotes", fields: [customerId], references: [id])

  content    String
  type       String  @default("GENERAL") // GENERAL, INTERNO, CLIENTE, SISTEMA
  isInternal Boolean @default(false) // Solo visible para staff

  createdById String
  createdBy   StaffMember @relation("NoteCreator", fields: [createdById], references: [id])
  createdAt   DateTime    @default(now())
}

// ============================================
// CITAS (Legacy - mantener compatibilidad)
// ============================================

model Appointment {
  id            String   @id @default(uuid())
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  serviceType   String
  scheduledDate DateTime
  status        String   @default("PENDING")
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// CONFIGURACIÓN DEL SISTEMA
// ============================================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("STRING") // STRING, NUMBER, BOOLEAN, JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// PARTICIPACIONES EN SORTEOS (Ruleta Loca)
// ============================================

model Participation {
  id         String   @id @default(uuid())
  campaignId String   // ID de la campaña en Sanity
  
  // Datos del participante
  name       String
  email      String
  phone      String   // WhatsApp
  country    String   @default("EC")
  
  // Tarjetas seleccionadas (JSON array de slugs)
  selectedCards String // JSON: ["visa-gold", "mastercard-platinum"]
  totalSpins    Int    @default(1)
  spinsUsed     Int    @default(0)
  
  // Resultado
  prizeId       String?  // ID del premio en Sanity (null si no ganó)
  prizeName     String?
  prizeCode     String?  @unique // Código único para canjear
  prizeStatus   String   @default("PENDING") // PENDING, VERIFIED, DELIVERED, EXPIRED
  
  // Verificación
  verifiedAt    DateTime?
  verifiedBy    String?
  deliveredAt   DateTime?
  
  // Integración CRM
  crmLeadId     String?
  
  // Metadata
  ipAddress     String?
  userAgent     String?
  source        String   @default("WEB") // WEB, KIOSK
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([campaignId])
  @@index([email])
  @@index([prizeCode])
}

// ============================================
// KNOWLEDGE BASE - ENUMS
// ============================================

enum SourceType {
  BLOB
  SANITY
  WEB
  SOCIAL
  RSS
  MANUAL
}

enum KBDocumentStatus {
  PENDING
  INDEXED
  FAILED
  OUTDATED
}

enum SentimentType {
  POSITIVE
  NEUTRAL
  NEGATIVE
  COMPLAINT
}

enum AlertType {
  COMPLAINT
  POLICY_CHANGE
  SYSTEM_ERROR
  MENTION
}

enum AlertPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// KNOWLEDGE BASE - SOURCES
// ============================================

model Source {
  id         String     @id @default(uuid())
  type       SourceType
  name       String
  config     String     // JSON configuration
  isActive   Boolean    @default(true)
  lastSyncAt DateTime?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relaciones
  kbDocuments KBDocument[]
}

// ============================================
// KNOWLEDGE BASE - DOCUMENTS
// ============================================

model KBDocument {
  id          String           @id @default(uuid())
  sourceId    String
  source      Source           @relation(fields: [sourceId], references: [id])
  externalId  String           // URL, Sanity _id, tweet ID, etc.
  title       String
  contentHash String           // SHA-256 para detectar cambios
  status      KBDocumentStatus @default(PENDING)
  metadata    String?          // JSON metadata
  indexedAt   DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relaciones
  chunks Chunk[]

  @@unique([sourceId, externalId])
  @@index([status])
  @@index([sourceId])
}

// ============================================
// KNOWLEDGE BASE - CHUNKS
// ============================================

model Chunk {
  id           String     @id @default(uuid())
  documentId   String
  document     KBDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  content      String
  position     Int
  metadata     String?    // JSON metadata
  createdAt    DateTime   @default(now())

  // Relaciones
  embedding Embedding?

  @@index([documentId])
}

// ============================================
// KNOWLEDGE BASE - EMBEDDINGS
// ============================================

model Embedding {
  id         String   @id @default(uuid())
  chunkId    String   @unique
  chunk      Chunk    @relation(fields: [chunkId], references: [id], onDelete: Cascade)
  vector     Bytes    // Serialized Float32Array
  model      String   // "text-embedding-004"
  dimensions Int      // 768
  createdAt  DateTime @default(now())
}

// ============================================
// CHATBOT - CONVERSATIONS
// ============================================

model Conversation {
  id         String    @id @default(uuid())
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])
  title      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relaciones
  messages ChatMessage[]

  @@index([customerId])
  @@index([createdAt])
}

// ============================================
// CHATBOT - MESSAGES
// ============================================

model ChatMessage {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // 'user' | 'assistant'
  content        String
  sources        String?      // JSON array of source citations
  createdAt      DateTime     @default(now())

  @@index([conversationId])
}

// ============================================
// SOCIAL LISTENING - MENTIONS
// ============================================

model SocialMention {
  id                String        @id @default(uuid())
  sourceId          String
  platform          String        // twitter, facebook, instagram
  externalId        String
  author            String
  content           String
  sentiment         SentimentType
  suggestedResponse String?
  reviewedAt        DateTime?
  reviewedBy        String?
  publishedAt       DateTime
  createdAt         DateTime      @default(now())

  // Relaciones
  alerts Alert[]

  @@unique([platform, externalId])
  @@index([sentiment])
  @@index([sourceId])
}

// ============================================
// ALERT DOMAINS (Catálogo normalizado)
// ============================================

model AlertDomain {
  id           String  @id @default(uuid())
  name         String  @unique // 'operations', 'business', 'social'
  displayName  String  // 'Operaciones', 'Negocio', 'Social'
  description  String?
  icon         String? // 'server', 'briefcase', 'message-circle'
  color        String? // '#ef4444', '#3b82f6', '#10b981'
  allowedRoles String  // JSON: ['ADMIN', 'DEV']
  isActive     Boolean @default(true)
  sortOrder    Int     @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  alerts Alert[]
}

// ============================================
// ALERTS
// ============================================

model Alert {
  id               String         @id @default(uuid())
  type             AlertType
  priority         AlertPriority
  domainId         String
  domain           AlertDomain    @relation(fields: [domainId], references: [id])
  channels         String?        // JSON array: ['email', 'slack', 'dashboard']
  title            String
  content          String
  context          String?        // JSON context
  sourceId         String?
  mentionId        String?
  mention          SocialMention? @relation(fields: [mentionId], references: [id])
  createdById      String?
  createdBy        StaffMember?   @relation("AlertCreator", fields: [createdById], references: [id])
  acknowledgedAt   DateTime?
  acknowledgedById String?
  acknowledgedBy   StaffMember?   @relation("AlertAcknowledger", fields: [acknowledgedById], references: [id])
  createdAt        DateTime       @default(now())

  @@index([type])
  @@index([priority])
  @@index([domainId])
  @@index([acknowledgedAt])
}
